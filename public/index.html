<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kuber.AI Clone â€” Onboarding + Voice Chat</title>
  <style>
    :root { --bg:#071025; --card:#0b1220; --muted:#9aa4b2; --accent:#7c3aed; --glass:rgba(255,255,255,0.03); }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071025,#0b1220);color:#e6eef6}
    .container{max-width:920px;margin:18px auto;padding:18px}
    .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    h1{margin:0 0 8px 0} p.lead{color:var(--muted);margin-top:0}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    @media(max-width:640px){ .grid{grid-template-columns:1fr} }
    .tile{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03);padding:18px;border-radius:10px;text-align:left;cursor:pointer}
    .tile h3{margin:8px 0 0 0;font-size:15px}
    .tile p{color:var(--muted);font-size:13px;margin:6px 0 0 0}
    .tile.selected{outline:3px solid rgba(124,58,237,0.18)}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#5b21b6);color:white;font-weight:700;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .chat-area{margin-top:16px;height:58vh;overflow:auto;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:10px}
    .bubble{padding:12px;border-radius:12px;margin:8px 0;max-width:78%;white-space:pre-wrap}
    .user{background:linear-gradient(90deg,#052e2e,#064242);color:#dffafa;margin-left:auto;border-bottom-right-radius:2px}
    .bot{background:linear-gradient(90deg,#0b1320,#111827);color:#e6eef6;border-bottom-left-radius:2px}
    .status{font-size:13px;color:var(--muted);margin-left:auto}
    .badge{padding:6px 8px;border-radius:999px;background:rgba(124,58,237,0.12);color:var(--accent);font-weight:600;font-size:12px}
    .error{color:#ffb3b3;background:rgba(255,100,100,0.04);padding:8px;border-radius:8px;margin-top:8px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
    input[type="text"]{flex:1;min-width:220px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    audio{width:100%;margin-top:10px;border-radius:8px}
    .hold{user-select:none}
  </style>
</head>
<body>
  <div class="container">
    <!-- Onboarding -->
    <div class="card" id="onboardCard">
      <h1>What financial goal do you want to tackle first?</h1>
      <p class="lead">Choose one to personalise the assistant's responses.</p>
      <div class="grid" id="optionsGrid">
        <div class="tile" data-topic="Learn About Money"><h3>Learn About Money</h3><p>Basics, budgeting, terms â€” explained simply.</p></div>
        <div class="tile" data-topic="Set Your Goals"><h3>Set Your Goals</h3><p>Create saving & investment plans for your goals.</p></div>
        <div class="tile" data-topic="Explore, Invest & Grow"><h3>Explore, Invest & Grow</h3><p>Discover investments â€” including gold & SIPs.</p></div>
        <div class="tile" data-topic="Track Your Finances"><h3>Track Your Finances</h3><p>Understand spending, budgets and tracking tools.</p></div>
      </div>
      <div style="display:flex;gap:12px;margin-top:14px;align-items:center">
        <button id="continueBtn" class="btn" disabled>Continue</button>
        <button id="skipBtn" class="btn secondary">Skip</button>
        <div style="margin-left:auto" class="status" id="onboardStatus">Select one option above</div>
      </div>
    </div>

    <!-- Chat -->
    <div class="card" id="chatCard" style="display:none">
      <div style="display:flex;align-items:center;gap:12px">
        <h2 id="chatHeader">Assistant</h2>
        <div class="badge" id="nudgeBadge" style="display:none">Gold nudge</div>
        <div class="status" id="statusText" style="margin-left:auto">Idle</div>
      </div>

      <div class="chat-area" id="chatArea">
        <div id="starterTip" style="opacity:0.7;color:#9aa4b2">
          Say something or type â€” try: "What is the gold price today?"
        </div>
      </div>

      <audio id="player" controls style="display:none"></audio>

      <div class="controls">
        <input type="text" id="textInput" placeholder="Type your question..."/>
        <button id="sendTextBtn" class="btn">Send</button>

        <!-- Press & hold to talk -->
        <button id="pttBtn" class="btn hold">ðŸŽ™ Hold to Talk</button>
      </div>

      <div id="errorBox" class="error" style="display:none"></div>
    </div>
  </div>

<script>
const API_BASE = window.location.origin; // same-origin (served by FastAPI)
const chatArea = document.getElementById('chatArea');
const statusText = document.getElementById('statusText');
const nudgeBadge = document.getElementById('nudgeBadge');
const player = document.getElementById('player');
const errorBox = document.getElementById('errorBox');

let selectedTopic = null;

// Onboarding
document.querySelectorAll('.tile').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tile').forEach(x=>x.classList.remove('selected'));
    t.classList.add('selected');
    selectedTopic = t.dataset.topic;
    document.getElementById('continueBtn').disabled = false;
    document.getElementById('onboardStatus').textContent = `Selected: ${selectedTopic}`;
  });
});
document.getElementById('continueBtn').addEventListener('click', openChat);
document.getElementById('skipBtn').addEventListener('click', () => { selectedTopic = "General"; openChat(); });

function openChat(){
  document.getElementById('onboardCard').style.display='none';
  document.getElementById('chatCard').style.display='block';
  document.getElementById('chatHeader').textContent = selectedTopic || 'Assistant';
}

function addBubble(text, who='bot'){
  const d = document.createElement('div');
  d.className = 'bubble ' + (who === 'you' ? 'user' : 'bot');
  d.textContent = text;
  chatArea.appendChild(d);
  chatArea.scrollTop = chatArea.scrollHeight;
  return d;
}

function showTyping(){
  const d = document.createElement('div');
  d.id = 'typing';
  d.className = 'bubble bot';
  d.textContent = 'â€¦typingâ€¦';
  chatArea.appendChild(d);
  chatArea.scrollTop = chatArea.scrollHeight;
}
function hideTyping(){
  const t = document.getElementById('typing');
  if(t) t.remove();
}

function setStatus(txt){ statusText.textContent = txt; }
function showError(msg){ errorBox.style.display='block'; errorBox.textContent = msg; console.error(msg); }

// Text chat
document.getElementById('sendTextBtn').addEventListener('click', async () => {
  const el = document.getElementById('textInput');
  const msg = el.value.trim();
  if(!msg) return;
  if(document.getElementById('starterTip')) document.getElementById('starterTip').remove();
  addBubble(msg,'you'); el.value='';
  setStatus('Thinkingâ€¦');
  showTyping();
  try{
    const fd = new FormData();
    fd.append('user_id','local-demo');
    fd.append('message', msg);
    fd.append('topic', selectedTopic || 'General');
    const res = await fetch(API_BASE + '/api/chat_text', { method:'POST', body: fd });
    if(!res.ok){ throw new Error(await res.text()); }
    const j = await res.json();
    hideTyping();
    addBubble(j.response_text || '(no reply)','bot');
    nudgeBadge.style.display = j.is_gold_nudge ? 'inline-block' : 'none';
    if(j.audio_url){
      const url = j.audio_url.startsWith('http') ? j.audio_url : API_BASE + j.audio_url;
      player.src = url; player.style.display='block';
      try{ await player.play(); }catch(e){}
    }
  }catch(e){
    hideTyping(); showError('Text failed: '+e.message);
  }finally{ setStatus('Idle'); }
});

// Press & Hold to Talk
let mediaRecorder, chunks=[];
const ptt = document.getElementById('pttBtn');

const startRec = async () => {
  errorBox.style.display='none';
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = onStop;
    mediaRecorder.start();
    ptt.textContent = 'ðŸ›‘ Release to Send';
    setStatus('Recordingâ€¦');
  }catch(e){
    showError('Mic not available: '+e.message);
  }
};
const stopRec = () => {
  if(mediaRecorder && mediaRecorder.state==='recording'){
    mediaRecorder.stop();
    setStatus('Processingâ€¦');
  }
  ptt.textContent = 'ðŸŽ™ Hold to Talk';
};

ptt.addEventListener('mousedown', startRec);
ptt.addEventListener('mouseup', stopRec);
ptt.addEventListener('mouseleave', stopRec);
ptt.addEventListener('touchstart', (e)=>{ e.preventDefault(); startRec(); }, {passive:false});
ptt.addEventListener('touchend', (e)=>{ e.preventDefault(); stopRec(); }, {passive:false});

async function onStop(){
  const blob = new Blob(chunks, {type:'audio/webm'});
  if(blob.size < 800){ setStatus('Idle'); return showError('Recorded audio too short.'); }
  if(document.getElementById('starterTip')) document.getElementById('starterTip').remove();
  addBubble('â€¦sending voiceâ€¦','you'); showTyping();
  try{
    const fd = new FormData();
    fd.append('audio', blob, 'input.webm');
    fd.append('user_id','local-demo');
    fd.append('topic', selectedTopic || 'General');
    const res = await fetch(API_BASE + '/api/chat_voice', { method:'POST', body: fd });
    if(!res.ok){ throw new Error(await res.text()); }
    const j = await res.json();
    hideTyping();
    addBubble(j.response_text || '(no reply)','bot');
    nudgeBadge.style.display = j.is_gold_nudge ? 'inline-block' : 'none';
    if(j.audio_url){
      const url = j.audio_url.startsWith('http') ? j.audio_url : API_BASE + j.audio_url;
      player.src = url; player.style.display='block';
      try{ await player.play(); }catch(e){}
    }
  }catch(e){
    hideTyping(); showError('Voice failed: '+e.message);
  }finally{
    setStatus('Idle');
  }
}
</script>
</body>
</html>
